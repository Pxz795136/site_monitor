# WAF监控系统优化需求文档

## 1. 项目背景

当前WAF监控系统需要支持多组URL监控，每组具有不同的监控阈值参数。为提高系统可靠性和维护性，需要对项目结构进行优化。

## 2. 优化目标

- 支持4个不同监控组的独立运行
- 每组可配置不同的监控参数
- 进程级隔离，避免单点故障
- 清晰的项目结构，便于管理和维护
- 进程标识清晰，易于区分不同监控组
- 增加脚本运行状态监控，确保监控进程持续运行
- 提高跨平台兼容性，支持在开发环境(Mac)和生产环境(CentOS 7)无缝切换
- 提供详细的监控日志记录功能，包括URL状态变化和告警历史

## 3. 优化后项目结构

```
waf/
├── waf_monitor/              # 主要代码目录
│   ├── __init__.py
│   ├── monitor.py            # 监控核心逻辑
│   ├── alerter.py            # 告警处理模块
│   ├── utils.py              # 工具函数
│   └── watchdog.py           # 脚本运行监控模块
├── conf/                     # 配置目录
│   ├── global.json           # 全局共享配置（可选）
│   ├── group1.json           # 第一组配置
│   ├── group2.json           # 第二组配置
│   ├── group3.json           # 第三组配置
│   ├── group4.json           # 第四组配置
│   ├── targets_group1.txt    # 第一组监控目标
│   ├── targets_group2.txt    # 第二组监控目标
│   ├── targets_group3.txt    # 第三组监控目标
│   └── targets_group4.txt    # 第四组监控目标
├── logs/                     # 统一日志目录
│   ├── group1/               # 第一组日志
│   │   ├── monitor.log       # 监控状态日志
│   │   ├── health.log        # 健康状态日志
│   │   └── alert.log         # 告警日志
│   ├── group2/               # 第二组日志
│   ├── group3/               # 第三组日志
│   ├── group4/               # 第四组日志
│   └── watchdog/             # 脚本监控日志
├── data/                     # 数据存储
│   ├── state_group1.json     # 第一组状态
│   ├── state_group2.json     # 第二组状态
│   ├── state_group3.json     # 第三组状态
│   ├── state_group4.json     # 第四组状态
│   └── watchdog.json         # 进程监控状态数据
├── bin/                      # 可执行脚本目录
│   ├── monitor_group1.py     # 第一组监控脚本
│   ├── monitor_group2.py     # 第二组监控脚本
│   ├── monitor_group3.py     # 第三组监控脚本
│   ├── monitor_group4.py     # 第四组监控脚本
│   ├── start_all.py          # 启动所有组的脚本
│   ├── stop_all.py           # 停止所有组的脚本
│   ├── status.py             # 查看所有组状态脚本
│   ├── watchdog.py           # 监控脚本运行状态
│   └── install.py            # 安装依赖脚本
├── requirements.txt          # 项目依赖
└── README.md                 # 项目说明
```

## 4. 功能需求

### 4.1 代码重构
- 将原监控代码分解为多个模块（monitor.py, alerter.py, utils.py）
- 支持通过命令行参数传入组标识
- 支持读取特定组的配置文件
- 使用setproctitle设置独特的进程名

### 4.2 配置文件设计
- 每个组的监控目标单独存储在对应的targets文件中
- 每个组的监控参数（如阈值、超时等）单独存储在对应的json配置文件中

### 4.3 脚本设计
- 使用Python替代Shell脚本，提高跨平台兼容性
- 为每个监控组创建独立的Python脚本，确保进程隔离
- 每个组脚本可独立启动和停止，互不影响
- 提供统一启动和停止所有组的便捷脚本
- 提供状态查询脚本，展示各组运行状态
- 所有脚本支持在Mac开发环境和CentOS 7生产环境一致运行

### 4.4 进程管理
- 每个监控组作为独立Python进程运行，避免单点故障
- 每个监控进程保存独立的PID文件
- 设置进程标题包含组标识，便于区分
- 使用Python的多进程模块，确保跨平台一致性

### 4.5 脚本运行监控
- 开发watchdog模块监控各监控进程的运行状态
- 检测到进程异常退出时自动重启对应进程
- 发送告警通知管理员进程异常情况
- 记录进程启动、停止、崩溃等事件日志
- 支持配置监控频率和自动重启尝试次数
- 提供进程健康状态的统计报告

### 4.6 日志记录功能
- 提供详细的结构化日志记录，包含时间戳、URL、状态码、响应时间等信息
- 记录URL监控的完整生命周期，包括加载、检测和状态变化
- 跟踪并记录每个URL的连续不健康次数
- 记录所有告警事件，包括告警触发和恢复通知
- 提供不同类型日志文件的分离（监控日志、健康状态日志、告警日志）
- 实现日志轮转机制，避免日志文件过大
- 支持定制日志格式，满足后续分析需求
- 支持日志级别控制，便于调试和生产环境切换

## 5. 迁移计划

1. 创建新的目录结构
2. 重构代码以支持组参数
3. 创建各组配置文件
4. 为每个监控组开发独立的Python脚本
5. 开发通用管理脚本（启动所有、停止所有、状态查询）
6. 实现脚本运行监控功能
7. 实现详细的日志记录功能
8. 测试单组功能
9. 测试多组并行运行
10. 测试脚本监控和自动恢复功能
11. 在Mac和CentOS 7环境测试兼容性

## 6. 依赖项

- Python 3.6+
- requests
- setproctitle（用于设置进程名）
- psutil（用于进程监控）
- argparse（用于命令行参数解析）
- logging（用于高级日志功能）

## 7. 注意事项

- 确保每个组的日志和状态数据相互隔离
- 避免多个组使用相同的PID文件
- 进程启动需设置正确的工作目录
- 使用Python脚本替代Shell脚本，避免跨平台shell命令差异
- 处理路径分隔符差异（Windows使用反斜杠，Unix使用正斜杠）
- watchdog自身应具有容错能力和自恢复机制
- 使用Python调度器替代crontab，提高跨平台兼容性
- 设置合理的告警阈值避免频繁告警干扰
- 保持每个组完全独立运行，一个组的故障不应影响其他组
- 日志文件需定期清理或轮转，避免磁盘空间耗尽

## 8. 脚本运行监控详细设计

### 8.1 监控方式
- 使用独立的watchdog进程定期检查各监控组进程状态
- 通过PID文件和进程存在性检查确认进程运行状态
- 监控进程CPU和内存使用情况，发现异常及时告警

### 8.2 自动恢复机制
- 检测到进程不存在时尝试重启对应监控组脚本
- 记录重启次数，超过阈值后发送严重告警
- 支持配置不同时间段的重启策略（如夜间可更激进地重启）

### 8.3 告警通知
- 使用与URL监控相同的告警渠道（企业微信）
- 支持配置不同级别的告警（如提醒、警告、严重）
- 告警信息包含详细的进程状态和错误日志摘要

### 8.4 监控报告
- 生成每日/每周监控组进程运行状态报告
- 统计各进程运行时间、重启次数、资源使用情况
- 提供可视化监控数据（可选功能）

## 9. 跨平台兼容性设计

### 9.1 独立进程脚本设计
```python
# 示例监控组脚本概念（不是实际代码）
import os
import sys
import time
import setproctitle
import json

# 设置进程名称
def set_proc_name(group_name):
    setproctitle.setproctitle(f"waf-monitor-{group_name}")

def main():
    # 获取组名称
    group_name = os.path.basename(__file__).split('_')[1].split('.')[0]
    
    # 设置进程名
    set_proc_name(group_name)
    
    # 读取组配置
    config_path = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 
                               'conf', f'{group_name}.json')
    
    # 加载配置
    with open(config_path, 'r') as f:
        config = json.load(f)
    
    # 记录PID
    pid_path = f'/var/run/waf_monitor_{group_name}.pid'
    with open(pid_path, 'w') as f:
        f.write(str(os.getpid()))
    
    # 实际监控逻辑
    # ...

if __name__ == "__main__":
    main()
```

### 9.2 路径处理
- 使用`os.path`模块处理路径，确保跨平台一致性
- 相对路径基于脚本位置计算，而非当前工作目录
- 配置文件中存储相对路径，运行时转换为绝对路径

### 9.3 进程管理
- 每个监控组使用独立Python进程
- 避免使用平台特定的进程管理命令
- 使用Python的信号处理机制处理进程终止
- watchdog脚本单独监控所有监控组进程状态

## 10. 日志系统详细设计

### 10.1 日志结构
- 使用Python的logging模块管理日志
- 为每个组创建独立的日志处理器
- 日志目录按组隔离，避免相互干扰
- 实现多类型日志文件的分离（监控状态、健康状态、告警日志）

### 10.2 日志格式
```
年-月-日 时:分:秒,毫秒 - 日志级别 - 日志消息
```

例如：
```
2025-05-09 22:28:32,010 - INFO - 未找到持久化的健康状态文件，将创建新的
2025-05-09 22:28:32,010 - INFO - 开始URL监控
2025-05-09 22:28:32,011 - INFO - 已加载 27 个URL
2025-05-09 22:28:55,428 - INFO - URL http://imcc34.eshore.cn:8000/ 已连续 2 次不健康，已发送告警
```

### 10.3 日志内容规范
- **监控状态日志**：记录监控脚本的运行状态，包括启动、停止、加载URL等
- **健康状态日志**：记录URL的健康状态变化，包括响应时间、状态码等
- **告警日志**：记录所有发送的告警信息，包括告警原因、发送时间、告警级别等
- **监控统计数据**：记录连续不健康次数、已监控次数、响应时间统计等

### 10.4 日志轮转机制
- 使用TimedRotatingFileHandler实现基于时间的日志轮转
- 默认日志保留30天
- 可配置单个日志文件的最大大小
- 对轮转后的日志文件进行自动压缩存档

### 10.5 日志查询与分析
- 日志文件使用标准格式，便于使用grep、awk等工具进行分析
- 日志中包含关键字段以便后续提取和统计
- 支持导出日志为CSV格式进行高级分析（可选功能） 